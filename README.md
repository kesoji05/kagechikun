# かげち君（不整形地評価ツール）

相続税申告における不整形地の土地評価を支援するWebアプリケーション。

## 概要

公図・測量図の画像を読み込み、GUI上で評価対象地・路線を指定することで、想定整形地の自動描画、かげ地割合・各種補正率の計算を行います。

既存の商用ソフト「蔭地名人」（エッサム社）の代替として開発されたオープンソースツールです。

## 主な機能

### 1. 画像読み込み・基準尺設定
- 公図・測量図の画像（JPG, PNG等）を読み込み
- 図面上の2点をクリックして基準尺を設定（実寸距離を入力）
- ズーム・パン操作で画像を自由に拡大縮小・移動

### 2. 評価対象地の作図
- 頂点をクリックして多角形を作成
- 各頂点に番号を表示（0から開始）
- 固定位置の拡大鏡で細かい位置調整が可能
- 実際の地積（㎡）を入力可能

### 3. 路線の指定
- 正面路線、側方路線1、側方路線2、二方路線を設定可能
- サイドパネルから頂点を選択して路線を指定
- 各路線に路線価（千円/㎡）を入力
- 同一種別の多重登録を防止

### 4. 想定整形地の自動計算
- 正面路線に基づいて想定整形地を自動計算
- 黄色の破線で想定整形地を描画
- 間口距離・奥行距離を自動測定

### 5. かげ地割合・補正率の計算
- かげ地割合の計算（計算過程も表示）
- 奥行価格補正率
- 不整形地補正率
- 間口狭小補正率
- 奥行長大補正率

### 6. 利用単位の分割
- 評価対象地を複数の利用単位に分割
- 各利用単位に名前と色を設定

### 7. 描画ツール
- 直線：2点をクリックして直線を描画
- 垂線：基準辺に垂直な線を描画
- 延線：既存の辺を延長
- 平行：基準辺に平行な線を描画

### 8. 回転表示
- 「正面↑」ボタンで正面路線が画面上部を向くように回転
- 「回転解除」で元の向きに戻す

## 技術スタック

- **フレームワーク**: React 19 + TypeScript
- **ビルドツール**: Vite 7
- **Canvas操作**: Fabric.js 7
- **状態管理**: Zustand 5
- **スタイリング**: Tailwind CSS 4

## プロジェクト構成

```
app/
├── src/
│   ├── components/
│   │   ├── Header.tsx       # ヘッダー（プロジェクト名表示）
│   │   ├── Toolbar.tsx      # ツールバー（各種操作ボタン）
│   │   ├── MainCanvas.tsx   # メインキャンバス（図面表示・描画）
│   │   └── SidePanel.tsx    # サイドパネル（入力・結果表示）
│   ├── store/
│   │   └── useStore.ts      # Zustand ストア（状態管理）
│   ├── types/
│   │   └── index.ts         # TypeScript 型定義
│   ├── utils/
│   │   └── calculations.ts  # 計算ロジック
│   ├── data/
│   │   └── correctionTables.ts  # 補正率表データ
│   ├── App.tsx              # メインアプリケーション
│   └── main.tsx             # エントリーポイント
├── package.json
└── vite.config.ts
```

## 主要な型定義

### Land（評価対象地）
```typescript
interface Land {
  id: string;
  name: string;
  vertices: Point[];           // 頂点座標
  roads: Road[];               // 路線情報
  areaType: AreaType;          // 土地種類
  chikaKubun: ChikaKubun;      // 地区区分
  actualArea?: number;         // 実際の地積（㎡）
  usageUnits?: UsageUnit[];    // 利用単位
  frontageIndices?: [number, number];  // 間口頂点インデックス
  passageArea?: number;        // 通路の面積（㎡）
}
```

### Road（路線）
```typescript
interface Road {
  id: string;
  type: RoadType;              // '正面' | '側方１' | '側方２' | '二方'
  points: [Point, Point];      // 路線の端点座標
  vertexIndices?: [number, number];  // 頂点インデックス
  rosenka: number;             // 路線価（千円/㎡）
  shakuchiken: ShakuchikenWariai;    // 借地権割合
  isKadochi: boolean;          // 角地フラグ
}
```

### CalculationResult（計算結果）
```typescript
interface CalculationResult {
  landId: string;
  landArea: number;            // 評価対象地面積（㎡）
  soteiSeikeichiArea: number;  // 想定整形地面積（㎡）
  frontage: number;            // 間口距離（m）
  depth: number;               // 奥行距離（m）
  calculatedDepth: number;     // 計算上の奥行距離（m）
  kagechWariai: number;        // かげ地割合（%）
  kagechArea: number;          // かげ地面積（㎡）
  // 各種補正率...
}
```

## 計算ロジック

### 面積計算
Shoelace formula（靴紐公式）を使用して多角形の面積を計算：
```
A = 0.5 * |Σ(x[i] * y[i+1] - x[i+1] * y[i])|
```

### かげ地割合
```
かげ地割合 = かげ地面積 / 想定整形地面積 × 100
かげ地面積 = 想定整形地面積 - 評価対象地面積
```

### 計算上の奥行距離
```
計算上の奥行距離 = 評価対象地面積 / 間口距離
```

### 想定整形地
正面路線に平行な辺を持ち、評価対象地を全て含む最小の矩形として計算。

## 補正率表

`src/data/correctionTables.ts` に以下の補正率表を内蔵：

- **奥行価格補正率表**: 地区区分と奥行距離に基づく補正率
- **不整形地補正率表**: 地区区分・地積区分・かげ地割合に基づく補正率
- **間口狭小補正率表**: 地区区分と間口距離に基づく補正率
- **奥行長大補正率表**: 地区区分と奥行/間口比に基づく補正率

## 使い方

### 開発サーバーの起動
```bash
cd app
npm install
npm run dev
```

### ビルド
```bash
npm run build
```

### 操作フロー
1. 「画像読込」で公図・測量図を読み込む
2. 「①対象地」で評価対象地の頂点をクリックして作図（ダブルクリックで完了）
3. サイドパネルで地区区分・地積を入力
4. サイドパネルの「路線の指定」で正面路線等を設定
5. 計算結果が自動表示される

## カラースキーム

| 要素 | 色 |
|------|-----|
| 評価対象地 | 青 (#3b82f6) |
| 正面路線 | 赤 (#ef4444) |
| 側方路線 | オレンジ (#f97316) |
| 二方路線 | 紫 (#a855f7) |
| 想定整形地 | 黄色破線 (#fbbf24) |
| 利用単位 | 各種色（半透明） |
| 基準尺 | 緑 (#22c55e) |

## 参考資料

- 財産評価基本通達 第20条（不整形地の評価）
- 国税庁「路線価図・評価倍率表」: https://www.rosenka.nta.go.jp/
- 蔭地名人（エッサム社）: https://www.yurikago.net/kagechimeijin/

## 用語集

| 用語 | 説明 |
|------|------|
| 不整形地 | 正方形・長方形でない、形が不規則な土地 |
| 想定整形地 | 不整形地を囲む最小の矩形 |
| かげ地 | 想定整形地のうち、評価対象地に含まれない部分 |
| かげ地割合 | かげ地面積 ÷ 想定整形地面積 × 100（%） |
| 間口距離 | 正面路線に接する長さ |
| 奥行距離 | 正面路線に垂直な方向の土地の深さ |
| 路線価 | 道路に面する土地の1㎡あたりの評価額（千円単位） |
| 地区区分 | 土地の利用状況による区分（普通住宅地区など） |
| 地積区分 | 土地の面積による区分（A/B/C） |

## ライセンス

MIT License
